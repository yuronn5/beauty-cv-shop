<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Amelie Admin">
<link rel="apple-touch-icon" href="/amelie/amelie/img/about/main-artist.png">
  <title>Admin — Bookings</title>
  <style>
    :root{ --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --text:#111827; --primary:#2563eb; --danger:#ef4444; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap{ max-width:980px; margin:32px auto; padding:0 16px; }
    .card{ background:var(--card); border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.08); padding:16px; }
    h1{ margin:0 0 12px; font-size:20px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:8px 0 12px; }
    input,button,select{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; font-size:14px; }
    button.primary{ background:var(--primary); color:#fff; border-color:transparent; }
    button.danger{ background:var(--danger); color:#fff; border-color:transparent; }
    .table{ width:100%; border-collapse:collapse; margin-top:12px; }
    .table th,.table td{ border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:14px; vertical-align:top; }
    .pill{ padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block; background:#eef2ff; color:#1e3a8a; }
    .pill.paid{ background:#ecfdf5; color:#065f46; }
    .pill.hold{ background:#fff7ed; color:#9a3412; }
    .muted{ color:var(--muted); }
    .right{ margin-left:auto; display:flex; gap:8px; }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .search{ flex:1; min-width:180px; }
    .empty{ text-align:center; padding:32px; color:var(--muted); }
    @media (max-width:600px){ .hide-sm{ display:none } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin — Bookings</h1>

      <div class="toolbar">
        <label>From <input type="date" id="from"></label>
        <label>To <input type="date" id="to"></label>
        <button id="load" class="primary">Load</button>
        <div class="right">
          <input id="q" class="search" placeholder="Search name/phone/date/time">
          <button id="csv">Export CSV</button>
          <button id="logout">Change PIN</button>
        </div>
      </div>
      <div class="hint">This page requires your admin PIN (same <code>ADMIN_KEY</code> used in the widget). Data is fetched from Netlify Functions.</div>

      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th class="hide-sm">Client</th>
            <th>Phone</th>
            <th>Status</th>
            <th class="hide-sm">Payment</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="empty">No data yet. Choose dates and click <b>Load</b>.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  const API = '/.netlify/functions';
  let ADMIN_KEY = sessionStorage.getItem('ADMIN_KEY') || null;
  const $ = s => document.querySelector(s);
  const tbody = $('#tbody');

  // default range: today .. +30d
  const today = new Date();
  const toISO = d => d.toISOString().slice(0,10);
  $('#from').value = toISO(today);
  const t2 = new Date(today); t2.setDate(today.getDate()+30);
  $('#to').value = toISO(t2);

  function askPin() {
    const pin = prompt('Enter admin PIN');
    if (!pin) return false;
    ADMIN_KEY = pin;
    sessionStorage.setItem('ADMIN_KEY', pin);
    return true;
  }

  async function api(path, params={}, method='GET', body=null) {
    const headers = { 'Content-Type':'application/json', 'X-Admin-Key': ADMIN_KEY };
    let url = `${API}${path}`;
    if (method === 'GET' && params && Object.keys(params).length){
      const u = new URL(url, location.origin);
      Object.entries(params).forEach(([k,v])=> u.searchParams.set(k, v));
      u.searchParams.set('_', Date.now()); // cache-bust
      url = u.toString();
    }
    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null, cache:'no-store' });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw Object.assign(new Error(json.error||'API error'), {status:res.status, json});
    return json;
  }

  function renderRows(rows){
    tbody.innerHTML = '';
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="7" class="empty">No bookings for selected range.</td></tr>`;
      return;
    }
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td class="hide-sm">${escapeHtml(r.name||'')}</td>
        <td>${escapeHtml(r.phone||'')}</td>
        <td>
          <span class="pill ${r.paid ? 'paid' : ''}">${r.paid ? 'paid' : 'booked'}</span>
        </td>
        <td class="hide-sm">${r.paymentId ? escapeHtml(r.paymentId) : '<span class="muted">—</span>'}</td>
        <td style="text-align:right">
          <button data-date="${r.date}" data-time="${r.time}" class="danger btn-cancel">Cancel</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

  function filterRows(all, q){
    if(!q) return all;
    const t = q.toLowerCase().trim();
    return all.filter(r =>
      (r.name||'').toLowerCase().includes(t) ||
      (r.phone||'').toLowerCase().includes(t) ||
      (r.date||'').toLowerCase().includes(t) ||
      (r.time||'').toLowerCase().includes(t)
    );
  }

  function toCSV(rows){
    const header = ['date','time','name','phone','status','paymentId'];
    const lines = [header.join(',')];
    rows.forEach(r=>{
      const status = r.paid ? 'paid' : 'booked';
      const vals = [r.date, r.time, r.name||'', r.phone||'', status, r.paymentId||'']
        .map(v => `"${(v||'').toString().replace(/"/g,'""')}"`);
      lines.push(vals.join(','));
    });
    return lines.join('\n');
  }

  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], { type: 'text/csv;charset=utf-8;' }));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // events
  $('#logout').addEventListener('click', ()=>{
    sessionStorage.removeItem('ADMIN_KEY'); ADMIN_KEY = null; alert('PIN cleared. Reload page and enter again.');
  });

  let allRows = [];
  $('#load').addEventListener('click', async ()=>{
    if (!ADMIN_KEY && !askPin()) return;
    const from = $('#from').value;
    const to = $('#to').value;
    try{
      const data = await api('/admin-list', { start: from, end: to }, 'GET');
      allRows = (data.rows||[]).sort((a,b)=> a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
      renderRows(filterRows(allRows, $('#q').value));
    }catch(e){
      alert(e?.json?.error || 'Failed to load'); console.error(e);
    }
  });

  $('#q').addEventListener('input', ()=>{
    renderRows(filterRows(allRows, $('#q').value));
  });

  $('#csv').addEventListener('click', ()=>{
    if(!allRows.length){ alert('Nothing to export'); return; }
    download(`bookings_${$('#from').value}_to_${$('#to').value}.csv`, toCSV(filterRows(allRows, $('#q').value)));
  });

  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn-cancel'); if(!btn) return;
    const date = btn.dataset.date, time = btn.dataset.time;
    if (!confirm(`Cancel booking on ${date} at ${time}? This will free the time slot.`)) return;
    try{
      await api('/admin-cancel', {}, 'POST', { date, time });
      // remove from UI
      allRows = allRows.filter(r => !(r.date===date && r.time===time));
      renderRows(filterRows(allRows, $('#q').value));
    }catch(err){
      alert(err?.json?.error || 'Cancel failed'); console.error(err);
    }
  });
</script>
</body>
</html>
