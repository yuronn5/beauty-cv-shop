<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
  <title>Календар запису</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    :root { --card-bg:#fff; --card-shadow:0 8px 30px rgba(0,0,0,.08); --muted:#6b7280; --danger:#ef4444; --primary:#2563eb; }
    body{ margin:0; background:#f5f7fb; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:40px 16px; }
    .widget{ width: 100%; max-width: 420px; background:var(--card-bg); border-radius:18px; box-shadow:var(--card-shadow); padding:16px; overflow:hidden; }
    .header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .title{ font-weight:700; font-size:18px; }
    #calendar{ background:#fff; border-radius:14px; padding:10px; }
    .admin-toggle{ display:flex; align-items:center; gap:6px; user-select:none; cursor:pointer; margin-top:8px; }
    .hint{ color:#6b7280; font-size:12px; margin:6px 0 0; }

    /* модалка */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(17,24,39,.45); z-index:9999; padding:16px; }
    .modal.open{ display:grid; }
    .sheet{ width:560px; max-width:100%; background:#fff; border-radius:16px; box-shadow:var(--card-shadow); padding:16px; animation:pop .12s ease-out; }
    @keyframes pop{ from{transform:scale(.98);opacity:.6} to{transform:scale(1);opacity:1} }
    .sheet h3{ margin:0 0 8px; font-size:16px; }
    .sub{ color:#6b7280; font-size:13px; margin-bottom:10px; }
    .slots{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; max-height:40vh; overflow:auto; padding-right:4px; }
    .slot{ border:1px solid #e5e7eb; border-radius:10px; padding:8px; text-align:center; cursor:pointer; font-weight:600; font-size:12px; background:#fff; white-space:nowrap; }
    .slot:hover{ border-color:#cbd5e1; }
    .slot.blocked{ background:#f9fafb; color:#9ca3af; text-decoration:line-through; cursor:not-allowed; }
    .slot.notfit{ opacity:.45; cursor:not-allowed; }
    .slot.selected{ outline:2px solid var(--primary); }

    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .form label{ font-size:12px; color:#374151; font-weight:600; display:block; }
    .form input{ margin-top:4px; width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:8px; font-size:13px; }

    .bar{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:8px; flex-wrap:wrap; }
    .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .right{ display:flex; gap:8px; }
    .btn{ border:1px solid #e5e7eb; background:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-size:13px; }
    .btn.primary{ background:var(--primary); color:#fff; border-color:transparent; }
    .btn.danger{ background:#ef4444; color:#fff; border-color:transparent; }

    .admin-list{ margin-top:10px; border-top:1px dashed #e5e7eb; padding-top:10px; }
    .admin-list h4{ margin:0 0 6px; font-size:13px; color:#111827; }
    .admin-list .row{ font-size:12px; color:#374151; display:flex; justify-content:space-between; gap:8px; padding:4px 0; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="header">
      <div class="title">Запис до майстра</div>
    </div>

    <label class="admin-toggle">
      <input type="checkbox" id="adminMode" />
      <strong>Адмін-режим</strong>
    </label>
    <div class="hint">Клікни по дню → обери старт. Бронювання блокує <b>45 хв</b> (внутрішній крок 15 хв). У місячній сітці індикаторів немає — зайнятість видно в модалці.</div>

    <div id="calendar"></div>
  </div>

  <!-- Схована форма для Netlify Forms (для нотифікацій) -->
  <form name="booking" data-netlify="true" netlify-honeypot="bot-field" hidden>
    <input type="hidden" name="form-name" value="booking" />
    <input type="text" name="name" />
    <input type="tel" name="phone" />
    <input type="text" name="date" />
    <input type="text" name="time" />
    <input type="text" name="duration" />
    <input type="text" name="bot-field" />
  </form>

  <!-- Модалка -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h3 id="modalDateTitle">Вибір часу</h3>
      <div class="sub">Робочі години: <b>08:00–20:00</b> • Тривалість: <b>45 хв</b></div>

      <div class="slots" id="slots"></div>

      <!-- Форма бронювання для клієнта -->
      <div class="form" id="clientForm">
        <div>
          <label>Ім’я
            <input id="nameInput" type="text" placeholder="Ім’я" />
          </label>
        </div>
        <div>
          <label>Телефон
            <input id="phoneInput" type="tel" placeholder="+380..." />
          </label>
        </div>
      </div>

      <!-- Список бронювань (видно лише в адмін-режимі) -->
      <div class="admin-list" id="adminList" style="display:none">
        <h4>Бронювання на день (адмін)</h4>
        <div id="adminRows"></div>
      </div>

      <div class="bar">
        <div class="left">
          <button class="btn danger" id="blockAllBtn">Заблокувати день</button>
          <button class="btn" id="unblockAllBtn">Розблокувати день</button>
          <button class="btn" id="adminBlockRangeBtn">Блок 45 хв від вибраного</button>
        </div>
        <div class="right">
          <button class="btn" id="closeBtn">Закрити</button>
          <button class="btn primary" id="bookBtn">Підтвердити</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    // ==== Конфіг ====
    const WORK_START = 8, WORK_END = 20;
    const SLOT_MINUTES = 15, SERVICE_DURATION = 45;

    // ==== DOM ====
    const $ = (s)=>document.querySelector(s);
    const modal = $('#modal'), slotsEl = $('#slots'), modalDateTitle = $('#modalDateTitle');
    const adminToggle = $('#adminMode'), blockAllBtn = $('#blockAllBtn'), unblockAllBtn = $('#unblockAllBtn');
    const adminBlockRangeBtn = $('#adminBlockRangeBtn'), bookBtn = $('#bookBtn'), closeBtn = $('#closeBtn');
    const nameInput = $('#nameInput'), phoneInput = $('#phoneInput');
    const adminList = $('#adminList'), adminRows = $('#adminRows'), clientForm = $('#clientForm');

    // ==== Стан ====
    let activeDateStr = null, selectedTime = null;
    let ADMIN_KEY = sessionStorage.getItem('ADMIN_KEY') || null;
    let dayBlocked = []; // ["HH:MM", ...]
    let dayBookings = []; // [{time, name, phone} або {time, name:'Зайнято'}]

    // ==== Утиліти часу ====
    function toTime(h,m){ return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    function parseTime(t){ const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
    function minutesToTime(min){ const h=Math.floor(min/60), m=min%60; return toTime(h,m); }
    function clampEnd(min){ return Math.min(min, WORK_END*60); }
    function genSlots(step){ const out=[]; for(let h=WORK_START;h<WORK_END;h++) for(let m=0;m<60;m+=step) out.push(toTime(h,m)); return out; }
    function rangeTimes(startTimeStr, dur = SERVICE_DURATION, step = SLOT_MINUTES){
      const startMin = parseTime(startTimeStr);
      const hardEnd = clampEnd(startMin + dur);
      let t = Math.ceil(startMin/step)*step;
      const out = [];
      if (startMin >= WORK_START*60 && startMin < WORK_END*60) out.push(minutesToTime(startMin));
      for (; t < hardEnd; t += step) if (t >= WORK_START*60 && t < WORK_END*60) out.push(minutesToTime(t));
      return out;
    }

    // ==== API (Netlify Functions) ====
    const API_BASE = '/.netlify/functions';
   async function api(path, { method='GET', data=null, admin=false } = {}){
    const headers = { 'Content-Type':'application/json' };
    if (admin && ADMIN_KEY) headers['X-Admin-Key'] = ADMIN_KEY;
    const res = await fetch(`${API_BASE}${path}?_=${Date.now()}`, {
        method,
        headers,
        body: data ? JSON.stringify(data) : null,
        cache: 'no-store'
    });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw Object.assign(new Error(json.error || 'API error'), { status: res.status, json });
    return json;
    }
    async function loadDay(dateStr, asAdmin=false){
    const headers = {};
    if (asAdmin && ADMIN_KEY) headers['X-Admin-Key'] = ADMIN_KEY;
    const url = new URL(`${API_BASE}/availability`, location.origin);
    url.searchParams.set('date', dateStr);
    url.searchParams.set('_', Date.now().toString()); // cache-bust
    const res = await fetch(url, { headers, cache: 'no-store' });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(json.error || 'availability error');
    return json;
    }

    // ==== Netlify Forms (для нотифікацій) ====
    function encode(data){ return Object.keys(data).map(k=>encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&'); }
    function isHttpOrigin(){ return location.protocol === 'http:' || location.protocol === 'https:'; }
    async function submitBookingForm({ name, phone, date, time, duration }){
      if(!isHttpOrigin()) return false; // у file:// не шлемо
      const payload = { "form-name": "booking", name, phone, date, time, duration, "bot-field": "" };
      const res = await fetch("/", { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body: encode(payload) });
      return res.ok;
    }

    // ==== UI логіка ====
    async function openModal(dateStr){
      activeDateStr = dateStr; selectedTime = null;
      nameInput.value = ''; phoneInput.value = '';
      modalDateTitle.textContent = new Date(dateStr+"T12:00:00").toLocaleDateString('uk-UA', { day:'2-digit', month:'long', year:'numeric' });

      try{
        const asAdmin = adminToggle.checked;
        const day = await loadDay(dateStr, asAdmin);
        dayBlocked = Array.from(new Set([
          ...(day.blocked||[]),
          ...((day.bookings||[]).flatMap(b => rangeTimes(b.time))) // гарантуємо блок під бронювання
        ])).sort((a,b)=>parseTime(a)-parseTime(b));
        dayBookings = day.bookings || [];
      }catch(e){
        dayBlocked = []; dayBookings = [];
        console.error(e);
        alert('Не вдалося завантажити зайнятість дня');
      }

      renderSlots(dateStr);
      renderAdminList();
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); activeDateStr=null; selectedTime=null; }

    function renderSlots(dateStr){
      slotsEl.innerHTML = '';
      const allSlots = genSlots(SLOT_MINUTES);

      allSlots.forEach(t=>{
        const blockedSlot = dayBlocked.includes(t);
        const fits = !rangeTimes(t).some(x => dayBlocked.includes(x));
        const btn = document.createElement('button');
        btn.className = 'slot' + (blockedSlot ? ' blocked' : '') + (!fits ? ' notfit' : '');
        btn.textContent = t;
        btn.addEventListener('click', ()=>{
          if(adminToggle.checked){
            if(fits){ adminBlock(t); } else { /* адмін не перемикає точкові хвилини в цій версії */ }
          } else {
            if(blockedSlot || !fits) return;
            slotsEl.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTime = t;
          }
        });
        slotsEl.appendChild(btn);
      });

      const isAdmin = adminToggle.checked;
      blockAllBtn.disabled = !isAdmin;
      unblockAllBtn.disabled = !isAdmin;
      adminBlockRangeBtn.disabled = !isAdmin || !selectedTime;
      clientForm.style.display = isAdmin ? 'none' : '';
      adminList.style.display = isAdmin ? '' : 'none';
      bookBtn.textContent = isAdmin ? 'Готово' : 'Підтвердити';
    }

    function renderAdminList(){
      if (!adminToggle.checked) return;
      adminRows.innerHTML = '';
      if (!dayBookings.length){
        adminRows.innerHTML = '<div class="row"><span>Бронювань немає</span></div>';
        return;
      }
      dayBookings
        .sort((a,b)=>parseTime(a.time)-parseTime(b.time))
        .forEach(b=>{
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<span>${b.time}</span><span>${b.name}${b.phone ? ' • ' + b.phone : ''}</span>`;
          adminRows.appendChild(row);
        });
    }

    // ==== Дії користувача / адміна ====
    async function adminBlock(time){
      if(!activeDateStr) return;
      try{
        await api('/book', { method:'POST', admin:true, data:{ date: activeDateStr, time, action:'admin-block' }});
        await openModal(activeDateStr);
      }catch(e){
        alert(e?.json?.error || 'Не вдалося заблокувати');
      }
    }

    blockAllBtn.addEventListener('click', async ()=>{
      if(!activeDateStr) return;
      try{
        await api('/book', { method:'POST', admin:true, data:{ date: activeDateStr, action:'block-day' } });
        await openModal(activeDateStr);
      }catch(e){ alert('Не вдалося заблокувати день'); }
    });

    unblockAllBtn.addEventListener('click', async ()=>{
      if(!activeDateStr) return;
      try{
        await api('/book', { method:'POST', admin:true, data:{ date: activeDateStr, action:'unblock-day' } });
        await openModal(activeDateStr);
      }catch(e){ alert('Не вдалося розблокувати день'); }
    });

    adminBlockRangeBtn.addEventListener('click', async ()=>{
      if(!activeDateStr || !selectedTime) return;
      try{
        await api('/book', { method:'POST', admin:true, data:{ date: activeDateStr, time: selectedTime, action:'admin-block' } });
        await openModal(activeDateStr);
      }catch(e){ alert(e?.json?.error || 'Не вдалося заблокувати'); }
    });

    bookBtn.addEventListener('click', async ()=>{
      if(adminToggle.checked){ closeModal(); return; }
      if(!selectedTime){ alert('Оберіть старт часу'); return; }
      const name = (nameInput.value||'').trim();
      const phone = (phoneInput.value||'').trim();
      if(!name || !phone){ alert('Вкажіть ім’я та телефон'); return; }

      // 1) бронювання на бекенді
      try{
        await api('/book', { method:'POST', data:{ date: activeDateStr, time: selectedTime, name, phone } });
      }catch(err){
        if (err.status === 409) { alert('Обраний проміжок вже недоступний. Оновіть список.'); await openModal(activeDateStr); return; }
        alert('Помилка бронювання'); return;
      }

      // 2) нотифікація через Netlify Forms (не критично)
      try{ await submitBookingForm({ name, phone, date: activeDateStr, time: selectedTime, duration: '45 хв' }); }catch{}

      alert(`Запис підтверджено: ${activeDateStr} о ${selectedTime}`);
      closeModal();
    });

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    adminToggle.addEventListener('change', ()=>{
      if (adminToggle.checked && !ADMIN_KEY) {
        const k = prompt('Введіть адмін-ключ');
        if (k) { ADMIN_KEY = k; sessionStorage.setItem('ADMIN_KEY', k); }
      }
    });

    // ==== Календар ====
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      selectable: false,
      dateClick: (info) => {
    // info.dateStr у форматі YYYY-MM-DD
    openModal(info.dateStr);
  }
    //   select: (info)=>{
    //     openModal(info.startStr);
    //     calendar.unselect();
    //   }
    });
    calendar.render();
  </script>
</body>
</html>
